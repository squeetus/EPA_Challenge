/*! epa_challenge 24-05-2016 */
var mongoose=require("mongoose"),Chemical=mongoose.model("Chemical");exports.chemicals=function(a,b,c){var d=a.query.limit&&a.query.limit<1e3?a.query.limit:10;Chemical.find({}).limit(d).exec(function(a,d){return a?c(a):d?void b.json(d):c("no data")})},exports.chemical=function(a,b,c){Chemical.findOne({cas:a.params.cas}).exec(function(d,e){return d?c(d):e?void b.json(e):c("no data for chemical with cas "+a.params.cas)})};var mongoose=require("mongoose"),Facility=mongoose.model("Facility"),Chemical=mongoose.model("Chemical"),readline=require("readline"),fs=require("fs"),facilities={},chemicals={},getBlankArray=function(){for(var a=[],b=0;27>b;b++)a.push(0);return a};exports.clearDBS=function(){Facility.find().remove(function(a){console.log("cleared facilities")})},exports.testFacility=function(){var a=new Facility;a.facility_name="testFacility",a.tri_facility_id=22222,a.parent_company="parent company",a.street_address="123 road",a.city="a city",a.county="a county",a.state="a state",a.zip=12345,a.bia_code=1,a.tribe="maybe tribe",a.loc=[-33.98,75.35],a.federal_facility="NO",a.primary_sic=1234,a.primary_naics=4321,a.chemicals=[],a.chemicals.push({air:[0,0,0],water:[0,1,0],land:[0,0,1],recycling:[0,0,0],recovery:[0,0,0],treatment:[0,0,0],offsite_disposal:[0,1,0],offsite_recovery:[1,1,0],offsite_recycling:[-1,0,1],offsite_treatment:[0,1,1],offsite_potws:[0,0,0]}),a.save()},exports.testChemical=function(){Chemical.find().remove(function(a){console.log("cleared chemicals")});var a=new Chemical;a.chemical="a Chemical",a.cas="N100",a.info.clean_air_act="NO",a.info.classification="TRI",a.info.metal="NO",a.info.metal_category=0,a.info.carcinogen="NO",a.info.measurement="Pounds",a.air=getBlankArray(),a.water=getBlankArray(),a.land=getBlankArray(),a.recycling=getBlankArray(),a.recovery=getBlankArray(),a.treatment=getBlankArray(),a.offsite_disposal=getBlankArray(),a.offsite_recycling=getBlankArray(),a.offsite_recovery=getBlankArray(),a.offsite_treatment=getBlankArray(),a.offsite_potws=getBlankArray(),a.save()},exports.read=function(a){a=a?a:1987;var b=0,c=[],d=fs.createReadStream("data/TRI_"+a+"_US.txt"),e=readline.createInterface({input:d});d.on("error",function(a){if("ENOENT"!==a.code)throw console.log(":("),a;console.log("File not found: ",a.path)}),e.on("line",function(a){var d=!1;0===c.length&&c.push(a.split("	").length);for(var e=0;e<c.length;e++)if(c[e]==a.split("	").length){d=!0;break}d||c.push(a.split("	").length),b++}),e.on("close",function(){console.log("fin: ",b," lines"),console.log("record lengths: ",c)})},exports.readFiles=function(){facilities={},chemicals={};var a=function(b){console.log("\n\nStarting",b);var c=0,d=fs.createReadStream("data/TRI_"+b+"_US.txt"),e=readline.createInterface({input:d});d.on("error",function(a){if("ENOENT"===a.code)return console.log("File not found: ",a.path),void finalize();throw a}),e.on("line",function(a){if(0!==c++){var b=a.split("	");103==b.length&&(b.splice(101,1),b[100]=b[100].substring(1)),void 0===facilities[b[1]]?(facilities[b[1]]={},Facility.construct(facilities[b[1]],b),isNaN(facilities[b[1]].zip)&&console.log(facilities[b[1]])):Facility.modify(facilities[b[1]],b)}}),e.on("close",function(){console.log("fin: ",c," lines from ",b),console.log("unique facilities: ",Object.keys(facilities).length),console.log("unique chemicals: ",Object.keys(chemicals).length),a(++b)})};a(1987)};var finalize=function(){var a=[];for(var b in facilities)a.push(facilities[b]);console.log(a.length);var c=0,d=function(b){console.log("beginning set starting at ",1e3*b),Facility.insertMany(a.slice(1e3*b,1e3*b+1e3),function(a){console.log(a,"inserted facs",1e3*b,"-",1e3*b+1e3),59>b&&d(++b)})};d(c)},mongoose=require("mongoose"),Facility=mongoose.model("Facility");exports.facilities=function(a,b,c){var d=a.query.limit&&a.query.limit<100?a.query.limit:1,e=a.query.chemicals?a.query.chemicals:!1;Facility.find({},{chemicals:e}).limit(d).exec(function(a,d){return a?c(a):d?void b.json(d):c("no data")})},exports.facility=function(a,b,c){Facility.findOne({tri_facility_id:a.params.fid}).exec(function(d,e){return d?c(d):e?void b.json(e):c("no data for facility with facility id "+a.params.fid)})};var mongoose=require("mongoose"),Schema=mongoose.Schema,Chemical=new Schema({chemical:{type:String,"default":""},cas:{type:String,"default":""},info:{clean_air_act:{type:String,"default":""},classification:{type:String,"default":""},metal:{type:String,"default":""},metal_category:{type:Number,"default":0},carcinogen:{type:String,"default":""},measurement:{type:String,"default":""}},air:[],water:[],land:[],recycling:[],recovery:[],treatment:[],offsite_disposal:[],offsite_recycling:[],offsite_recovery:[],offsite_treatment:[],offsite_potws:[]});Chemical.statics.construct=function(a,b){var c=0;for(a.chemical=b[26],a.cas=b[27],a.info={},a.info.clean_air_act=b[28],a.info.classification=b[29],a.info.metal=b[30],a.info.metal_category=parseFloat(b[31]),isNaN(a.info.metal_category)&&(a.info.metal_category=null),a.info.carcinogen=b[32],a.info.measurement=b[34],a.air=[],a.water=[],a.land=[],a.recycling=[],a.recovery=[],a.treatment=[],a.offsite_disposal=[],a.offsite_recycling=[],a.offsite_recovery=[],a.offsite_treatment=[],a.offsite_potws=[],c+1987;2014>c+1987;c++)a.air[c]=0,a.water[c]=0,a.land[c]=0,a.recycling[c]=0,a.recovery[c]=0,a.treatment[c]=0,a.offsite_disposal[c]=0,a.offsite_recycling[c]=0,a.offsite_recovery[c]=0,a.offsite_treatment[c]=0,a.offsite_potws[c]=0;c=parseInt(b[0])-1987,a.air[c]=parseFloat(b[35])+parseFloat(b[36]),a.water[c]=parseFloat(b[37]);for(var d=0;8>d;d++)a.land[c]+=parseFloat(b[d+38]);a.recycling[c]=parseFloat(b[93]),a.recovery[c]=parseFloat(b[91]),a.treatment[c]=parseFloat(b[95]),a.offsite_disposal[c]=parseFloat(b[68]),a.offsite_recycling[c]=parseFloat(b[74]),a.offsite_recovery[c]=parseFloat(b[77]),a.offsite_treatment[c]=parseFloat(b[84]),a.offsite_potws[c]=parseFloat(b[50])},Chemical.statics.modify=function(a,b){i=parseInt(b[0])-1987,a.air[i]+=parseFloat(b[35])+parseFloat(b[36]),a.water[i]+=parseFloat(b[37]);for(var c=0;8>c;c++)a.land[i]+=parseFloat(b[c+38]);a.recycling[i]+=parseFloat(b[93]),a.recovery[i]+=parseFloat(b[91]),a.treatment[i]+=parseFloat(b[95]),a.offsite_disposal[i]+=parseFloat(b[68]),a.offsite_recycling[i]+=parseFloat(b[74]),a.offsite_recovery[i]+=parseFloat(b[77]),a.offsite_treatment[i]+=parseFloat(b[84]),a.offsite_potws[i]+=parseFloat(b[50])},mongoose.model("Chemical",Chemical);var mongoose=require("mongoose"),Chemical=mongoose.model("Chemical"),Schema=mongoose.Schema,Facility=new Schema({tri_facility_id:{type:String,"default":""},parent_company:{type:String,"default":""},facility_name:{type:String,"default":""},street_address:{type:String,"default":""},city:{type:String,"default":""},county:{type:String,"default":""},state:{type:String,"default":""},zip:{type:Number,"default":0},bia_code:{type:String,"default":""},tribe:{type:String,"default":""},loc:{type:[Number],index:"2dsphere","default":[null,null]},federal_facility:{type:String,"default":""},primary_sic:{type:Number,"default":0},primary_naics:{type:Number,"default":0},chemicals:{}}),makeChemical=function(a){var b={},c=0;for(b.chemical=a[26],b.air=[],b.water=[],b.land=[],b.recycling=[],b.recovery=[],b.treatment=[],b.offsite_disposal=[],b.offsite_recycling=[],b.offsite_recovery=[],b.offsite_treatment=[],b.offsite_potws=[],c+1987;2014>c+1987;c++)b.air[c]=0,b.water[c]=0,b.land[c]=0,b.recycling[c]=0,b.recovery[c]=0,b.treatment[c]=0,b.offsite_disposal[c]=0,b.offsite_recycling[c]=0,b.offsite_recovery[c]=0,b.offsite_treatment[c]=0,b.offsite_potws[c]=0;c=parseInt(a[0])-1987,b.air[c]=parseFloat(a[35])+parseFloat(a[36]),b.water[c]=parseFloat(a[37]);for(var d=0;8>d;d++)b.land[c]+=parseFloat(a[d+38]);return b.recycling[c]=parseFloat(a[93]),b.recovery[c]=parseFloat(a[91]),b.treatment[c]=parseFloat(a[95]),b.offsite_disposal[c]=parseFloat(a[68]),b.offsite_recycling[c]=parseFloat(a[74]),b.offsite_recovery[c]=parseFloat(a[77]),b.offsite_treatment[c]=parseFloat(a[84]),b.offsite_potws[c]=parseFloat(a[50]),b},updateChemical=function(a,b){i=parseInt(b[0])-1987,a.air[i]+=parseFloat(b[35])+parseFloat(b[36]),a.water[i]+=parseFloat(b[37]);for(var c=0;8>c;c++)a.land[i]+=parseFloat(b[c+38]);a.recycling[i]+=parseFloat(b[93]),a.recovery[i]+=parseFloat(b[91]),a.treatment[i]+=parseFloat(b[95]),a.offsite_disposal[i]+=parseFloat(b[68]),a.offsite_recycling[i]+=parseFloat(b[74]),a.offsite_recovery[i]+=parseFloat(b[77]),a.offsite_treatment[i]+=parseFloat(b[84]),a.offsite_potws[i]+=parseFloat(b[50])};Facility.statics.construct=function(a,b){a.tri_facility_id=b[1],a.parent_company=b[100],a.facility_name=b[2],a.street_address=b[3],a.city=b[4],a.county=b[5],a.state=b[6],a.zip=parseFloat(b[7]),a.bia_code=b[8],a.tribe=b[9],!b[10]||isNaN(parseFloat(b[10]))?(console.log("boop",b[10],parseFloat(b[10]),isNaN(parseFloat(b[10]))),a.loc=null):!b[11]||isNaN(parseFloat(b[11]))?(console.log("boop",b[11],parseFloat(b[11]),isNaN(parseFloat(b[11]))),a.loc=null):a.loc=[parseFloat(b[11]),parseFloat(b[10])],a.federal_facility=b[12],a.primary_sic=parseFloat(b[13]),isNaN(a.primary_sic)&&(a.primary_sic=null),a.primary_naics=b[19]?parseFloat(b[19]):-1,isNaN(a.primary_naics)&&(a.primary_naics=null),a.chemicals={},a.chemicals[b[27]]=makeChemical(b)},Facility.statics.modify=function(a,b){a.chemicals[b[27]]?updateChemical(a.chemicals[b[27]],b):a.chemicals[b[27]]=makeChemical(b)},mongoose.model("Facility",Facility);